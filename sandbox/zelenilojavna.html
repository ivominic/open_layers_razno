<!DOCTYPE html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Katastar zelenila</title>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../assets/ol3/css/ol.css" type="text/css" />
  <link rel="stylesheet" href="../assets/ol3/css/ol3-layerswitcher.css" type="text/css" />
  <link rel="stylesheet" href="../assets/css/samples.css" type="text/css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../assets/ol3/css/ol3-sidebar.css" type="text/css" />
</head>
<html>
  <body>
    <div class="row">
      <div class="panel-heading text-center panel-relative">
        <h1>Katastar zelenila</h1>
      </div>
    </div>
    <div class="row"></div>
    <div class="row">
      <div id="map"></div>

      <div id="overlay" style="background-color: white; border-radius:10px; border: 1px solid black; padding: 5px 10px;"></div>
    </div>

    <div id="sidebar" class="sidebar collapsed">
      <!-- Nav tabs -->
      <div class="sidebar-tabs">
        <ul role="tablist">
          <li>
            <a href="#filter" role="tab"><i class="fa fa-bars"></i></a>
          </li>
          <li>
            <a href="#podaci" role="tab"><i class="fa fa-globe"></i></a>
          </li>
        </ul>
      </div>

      <!-- Tab panes -->
      <div class="sidebar-content">
        <div class="sidebar-pane" id="filter">
          <h1 class="sidebar-header">
            Filter
            <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
          </h1>
          <div>
            <label for="ddlLejer">Odaberite lejer:</label><br />
            <select id="ddlLejer" class="form-control">
              <option value="winsoft:drvece">Drveće</option>
              <option value="winsoft:zbunje">Žbunje</option>
              <option value="winsoft:zelene_povrsine">Zelene površine</option>
              <option value="winsoft:rekreativne_povrsine">Rekreativne površine</option>
              <option value="winsoft:urbani_mobilijar">Urbani mobilijar</option>
            </select>
          </div>
          <div class="form-group">
            <label for="atribut">Odaberite atribut pretrage:</label>
            <select class="form-control" id="atribut">
              <option value="name">Name</option>
              <option value="description">Description</option>
            </select>
          </div>
          <div class="form-group input-group">
            <input type="text" class="form-control" id="vrijednost" placeholder="Vrijednost atributa pretrage" />
            <div class="input-group-append">
              <button type="button" class="btn btn-info" id="btnAtribut">
                Dodaj atribut
              </button>
            </div>
          </div>
          <div class="form-group">
            <button type="button" class="btn btn-success" id="btnPretraga">Pretraga</button>
            <button type="button" class="btn btn-danger" id="btnRestart">Restart</button>
            <button type="button" class="btn btn-info" id="btnKopiranjeLinka">Link</button>

            <table id="tblAtributi" class=" table order-list table-responsive">
              <thead>
                <tr>
                  <th>Lejer</th>
                  <th>Atribut</th>
                  <th>Vrijednost</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="sidebar-pane" id="podaci">
          <h1 class="sidebar-header">
            Podaci<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
          </h1>
        </div>
      </div>
    </div>

    <!--<script src="../assets/ol3/js/ol.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.6.0/ol.js"></script>
    <!--<script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.2.0/build/ol.js"></script>-->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="../assets/ol3/js/ol3-layerswitcher.js"></script>
    <script src="../assets/ol3/js/ol3-sidebar.js"></script>
    <script>
      //var urlOrigin = window.location.origin;
      var urlOrigin = "http://localhost:8088/";
      var wmsUrl = "http://localhost:8088/geoserver/winsoft/wms";
      var imageUrl = urlOrigin + "slike/";
      var osmPodloga = new ol.layer.Tile({ source: new ol.source.OSM(), name: "Podloga" });
      var overlay = new ol.Overlay({ position: "bottom-center", element: document.querySelector("#overlay") });
      var esri = new ol.layer.Tile("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");

      var idObjekta;

      function popuniKontrole(odgovor) {
        var atributi = odgovor.features[0]["properties"];
        idObjekta = odgovor.features[0]["id"];

        //slika
        var slika = atributi["url_fotografije"];
        slika.length && (slika = slika.substring(slika.lastIndexOf("/") + 1, slika.length));
        overlay.getElement().innerHTML = '<a target="_blank" href="' + imageUrl + slika + '"><img src="' + imageUrl + slika + '"></a>';
      }

      //Da na ENTER ima istu funkcionalnost kao na save
      $(document).keypress(function(event) {
        if (event.which === 13) {
          //TODO: akcija na enter
        }
      });

      function restartovanje() {
        idObjekta = "";

        overlay.getElement().innerHTML = "";
      }

      var drveceLejer = new ol.layer.Tile({
        title: "Drveće",
        name: "Drvece",
        source: new ol.source.TileWMS({
          url: wmsUrl,
          params: {
            LAYERS: "winsoft:drvece",
            TILED: false
          },
          serverType: "geoserver",
          crossOrigin: "anonymous"
        })
      });

      var zbunjeLejer = new ol.layer.Tile({
        title: "Žbunje",
        name: "Zbunje",
        source: new ol.source.TileWMS({
          url: wmsUrl,
          params: {
            LAYERS: "winsoft:zbunje",
            TILED: false
          },
          serverType: "geoserver",
          crossOrigin: "anonymous"
        })
      });

      var urbaniMobilijarLejer = new ol.layer.Tile({
        title: "Urbani mobilijar",
        name: "UrbaniMobilijar",
        source: new ol.source.TileWMS({
          url: wmsUrl,
          params: {
            LAYERS: "winsoft:urbani_mobilijar",
            TILED: false
          },
          serverType: "geoserver",
          crossOrigin: "anonymous"
        })
      });

      var zelenePovrsineLejer = new ol.layer.Tile({
        title: "Zelene povrišine",
        name: "ZelenePovrsine",
        source: new ol.source.TileWMS({
          url: wmsUrl,
          params: {
            LAYERS: "winsoft:zelene_povrsine",
            TILED: false
          },
          serverType: "geoserver",
          crossOrigin: "anonymous"
        })
      });

      var rekreativnePovrsineLejer = new ol.layer.Tile({
        title: "Rekreativne povrišine",
        name: "RekreativnePovrsine",
        source: new ol.source.TileWMS({
          url: wmsUrl,
          params: {
            LAYERS: "winsoft:rekreativne_povrsine",
            TILED: false
          },
          serverType: "geoserver",
          crossOrigin: "anonymous"
        })
      });

      var center = ol.proj.transform([19.26, 42.443], "EPSG:4326", "EPSG:3857");
      var view = new ol.View({
        center: center,
        zoom: 17
      });

      var map = new ol.Map({
        target: "map",
        view: view,
        layers: [
          new ol.layer.Group({
            title: "Podloga",
            layers: [
              new ol.layer.Tile({
                title: "Open Street Maps",
                type: "base",
                visible: true,
                source: new ol.source.OSM()
              }),
              new ol.layer.Tile({
                title: "Open Topo Maps",
                type: "base",
                visible: true,
                source: new ol.source.XYZ({
                  url: "https://{a-c}.tile.opentopomap.org/{z}/{x}/{y}.png"
                })
              }),
              new ol.layer.Tile({
                title: "Pješačka mapa",
                type: "base",
                visible: true,
                source: new ol.source.XYZ({
                  url: "https://tiles.wmflabs.org/hikebike/{z}/{x}/{y}.png"
                })
              }),
              new ol.layer.Tile({
                title: "Road Maps",
                type: "base",
                visible: true,
                source: new ol.source.XYZ({
                  url:
                    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}" /*,
                  attributions: [
                    new ol.Attribution({
                      html:
                        "Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012"
                    })
                  ]*/
                })
              }),
              new ol.layer.Tile({
                title: "Satelitski snimak",
                type: "base",
                source: new ol.source.XYZ({
                  url: "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                  maxZoom: 23
                })
              })
            ]
          }),
          new ol.layer.Group({
            title: "Podaci",
            layers: [urbaniMobilijarLejer, rekreativnePovrsineLejer, zelenePovrsineLejer, zbunjeLejer, drveceLejer]
          })
        ]
      });

      var layerSwitcher = new ol.control.LayerSwitcher({
        tipLabel: "Lejeri"
      });
      map.addControl(layerSwitcher);

      map.on("pointermove", onMouseMove);

      $("#btnAtribut").on("click", function() {
        dodajAtribut();
      });

      function onMouseMove(browserEvent) {
        var coordinate = browserEvent.coordinate;
        var pixel = map.getPixelFromCoordinate(coordinate);
        /*var el = document.getElementById("name");
                      el.innerHTML = "";
                      map.forEachFeatureAtPixel(pixel, function(feature) {
                        el.innerHTML += feature.get("broj") + "<br>";
                      });*/
      }

      var dragAndDrop = new ol.interaction.DragAndDrop({
        formatConstructors: [ol.format.GPX, ol.format.GeoJSON, ol.format.IGC, ol.format.KML, ol.format.TopoJSON]
      });

      dragAndDrop.on("addfeatures", function(event) {
        var vectorSource = new ol.source.Vector({
          features: event.features,
          projection: event.projection
        });
        map.getLayers().push(
          new ol.layer.Vector({
            source: vectorSource,
            style: vectorStyle
          })
        );
        view.fitExtent(vectorSource.getExtent(), map.getSize());
      });
      map.addInteraction(dragAndDrop);

      var sidebar = new ol.control.Sidebar({ element: "sidebar", position: "left" });
      map.addControl(sidebar);

      //Klik na feature
      map.on("click", onMouseClick);

      function onMouseClick(browserEvent) {
        var coordinate = browserEvent.coordinate;
        var pixel = map.getPixelFromCoordinate(coordinate);

        map.forEachLayerAtPixel(pixel, function(layer) {
          console.log(pixel);
          console.log(layer);
          var title = layer.get("title");
          console.log(title);
        });

        /*map.forEachFeatureAtPixel(pixel, function(feature, layer) {
          var idLayer = layer.get("myLayerID");
          console.log("lejer", idLayer);
        });*/

        console.log("radi");

        var url = drveceLejer.getSource().getGetFeatureInfoUrl(browserEvent.coordinate, map.getView().getResolution(), "EPSG:3857", { INFO_FORMAT: "application/json" });
        if (url) {
          fetch(url)
            .then(function(response) {
              restartovanje();
              return response.text();
            })
            .then(function(json) {
              let odgovor = JSON.parse(json);
              if (odgovor.features.length > 0) {
                popuniKontrole(odgovor);
              }
            });
        }

        console.log("radi dalje");

        overlay.setPosition(coordinate);
        map.addOverlay(overlay);
      }

      /**
       * Dodaje atribute za CQL upit
       */
      function dodajAtribut() {
        var atributNaziv = $("#atribut option:selected").text();
        var atributValue = $("#atribut option:selected").val();
        var lejerNaziv = $("#ddlLejer option:selected").text();
        var lejerValue = $("#ddlLejer option:selected").val();
        var vrijednost = $("#vrijednost").val();

        if (vrijednost.trim() === "" || typeof vrijednost === undefined) {
          alert("Potrebno je unijeti vrijednost atributa");
        } else {
          AddAttribute(lejerNaziv, lejerValue, atributNaziv, atributValue, vrijednost);
        }
      }

      function AddAttribute(lejerNaziv, lejerValue, atributNaziv, atributValue, vrijednost) {
        var tBody = $("#tblAtributi > TBODY")[0];

        var noviAtribut = true;
        $("#tblAtributi tr").each(function(i, row) {
          if (i > 0) {
            if (row.cells[0].innerHTML == lejerNaziv && row.cells[1].innerHTML == atributValue) {
              row.cells[2].innerHTML = row.cells[2].innerHTML + ";" + vrijednost;
              noviAtribut = false;
            }
          }
        });

        if (noviAtribut) {
          row = tBody.insertRow(-1);

          var cell = $(row.insertCell(-1));
          cell.html(lejerNaziv);
          cell = $(row.insertCell(-1));
          cell.html(atributValue);
          cell = $(row.insertCell(-1));
          cell.html(vrijednost);

          cell = $(row.insertCell(-1));
          var btnRemove = $("<input />");
          btnRemove.attr("type", "button");
          btnRemove.attr("class", "btn btn-danger btn-sm");
          //btnRemove.attr("onclick", "RemoveAttribute(this);");
          btnRemove.val("X");
          cell.append(btnRemove);
          dodajClickEventRemoveDugmetu(btnRemove);
        }
      }
    </script>
  </body>
</html>
