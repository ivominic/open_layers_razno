<!DOCTYPE html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Katastarske parcele u slivu Morače</title>
  <link rel="stylesheet" href="../assets/ol3/css/ol.css" type="text/css" />
  <link rel="stylesheet" href="../assets/css/samples.css" type="text/css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
</head>
<html>
  <body>
    <div class="row">
      <div class="panel-heading text-center panel-relative">
        <h1>Katastar zelenila</h1>
      </div>
    </div>
    <div class="row"></div>
    <div class="row">
      <div class="col-md-3">
        <div class="form-group">
          <div class="col-md-6">
            <label for="latinskiNaziv">Latinski naziv:</label>
            <input type="text" id="latinskiNaziv" />
          </div>
          <div class="col-md-6">
            <label for="narodniNaziv">Narodni naziv:</label>
            <input type="text" id="narodniNaziv" />
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <label for="tip">Tip:</label>
            <input type="text" id="tip" />
          </div>
          <div class="col-md-6">
            <label for="tipKragne">Tip kragne:</label>
            <input type="text" id="tipKragne" />
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <label for="visinaStabla">Visina stabla (m):</label>
            <input type="number" id="visinaStabla" />
          </div>
          <div class="col-md-6">
            <label for="visinaDebla">Visina debla (m):</label>
            <input type="number" id="visinaDebla" />
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <label for="prsniPrecnik">Prsni prečnik (cm):</label>
            <input type="number" id="prsniPrecnik" />
          </div>
          <div class="col-md-6">
            <label for="sirinaKrosnje">Širina krošnje:</label>
            <input type="number" id="sirinaKrosnje" />
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <label for="fitopatoloskePromjene">Fitopatološke promjene:</label>
            <input type="text" id="fitopatoloskePromjene" />
          </div>
          <div class="col-md-6">
            <label for="vrstaFitopatoloskePromjene">Vrsta fp promjene:</label>
            <input type="text" id="vrstaFitopatoloskePromjene" />
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <label for="entomoloskePromjene">Entomološke promjene:</label>
            <input type="text" id="entomoloskePromjene" />
          </div>
          <div class="col-md-6">
            <label for="vrstaEntomoloskePromjene">Vrsta em promjene:</label>
            <input type="text" id="vrstaEntomoloskePromjene" />
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <label for="izrazenostOtvoreneTruleziDebla">Izražena trulež debla:</label>
            <input type="text" id="izrazenostOtvoreneTruleziDebla" />
          </div>
          <div class="col-md-6">
            <label for="velicinaOtvoreneTruleziDebla">Veličina truleži debla:</label>
            <input type="text" id="velicinaOtvoreneTruleziDebla" />
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <label for="izrazenostOtvoreneTruleziGrana">Izražena trulež grana:</label>
            <input type="text" id="izrazenostOtvoreneTruleziGrana" />
          </div>
          <div class="col-md-6">
            <label for="velicinaOtvoreneTruleziGrana">Veličina truleži grana:</label>
            <input type="text" id="velicinaOtvoreneTruleziGrana" />
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <label for="ocjenaVitalnosti">Ocjena vitalnosti:</label>
            <input type="text" id="ocjenaVitalnosti" />
          </div>
          <div class="col-md-6">
            <label for="ocjenaDekorativnosti">Ocjena dekorativnosti:</label>
            <input type="text" id="ocjenaDekorativnosti" />
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <label for="starost">Starost (godina):</label>
            <input type="number" id="starost" />
          </div>
          <div class="col-md-6">
            <label for="ocekivanoTrajanjeZivota">Vijek trajanja (godina):</label>
            <input type="number" id="ocekivanoTrajanjeZivota" />
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <label for="vrijemeSadnje">Vrijeme sadnje:</label>
            <input type="text" id="vrijemeSadnje" />
          </div>
          <div class="col-md-6">
            <label for="cijenaSadnice">Cijena sadnice:</label>
            <input type="number" id="cijenaSadnice" />
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <label for="napomena">Napomena:</label>
            <input type="text" id="napomena" />
          </div>
          <div class="col-md-6">
            <label for="ostaliDetalji">Ostali detalji:</label>
            <input type="text" id="ostaliDetalji" />
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <input type="checkbox" id="slomljeneGrane" />
            <label for="slomljeneGrane">Slomljene grane</label>
          </div>
          <div class="col-md-6">
            <input type="checkbox" id="suveGrane" />
            <label for="suveGrane">Suve grane</label>
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <input type="checkbox" id="suhovrhost" />
            <label for="suhovrhost">Suhovrhost</label>
          </div>
          <div class="col-md-6">
            <input type="checkbox" id="kvalitet" />
            <label for="kvalitet">Za uklanjanje</label>
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <input type="checkbox" id="isjeceneDebeleGrane" />
            <label for="isjeceneDebeleGrane">Isječene debele grane</label>
          </div>
          <div class="col-md-6">
            <input type="checkbox" id="premazivanjeNakonSjece" />
            <label for="premazivanjeNakonSjece">Premazivanje sječe</label>
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-6">
            <input type="checkbox" id="isjecenoUklonjenoStablo" />
            <label for="isjecenoUklonjenoStablo">Isječeno stablo</label>
          </div>
          <div class="col-md-6">
            <input type="checkbox" id="pripadnostDrvoredu" />
            <label for="pripadnostDrvoredu">Pripada drvoredu</label>
          </div>
        </div>
        <div class="form-group">
          <button type="button" class="btn btn-danger" id="btnPonisti" onclick="restartovanje()">Poništi</button>
          <button type="button" class="btn btn-primary" id="btnSacuvaj" onclick="sacuvaj()">Sačuvaj</button>
        </div>
        <div id="info"></div>
        <div id="layertree"></div>
        <div id="name"></div>
      </div>
      <div class="col-md-9">
        <div id="map"></div>

        <div id="overlay" style="background-color: white; border-radius:10px; border: 1px solid black; padding: 5px 10px;"></div>
      </div>
    </div>

    <!--<script src="../assets/ol3/js/ol.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.6.0/ol.js"></script>
    <!--<script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.2.0/build/ol.js"></script>-->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script>
      var urlOrigin = window.location.origin;
      var wmsUrl = "http://localhost:8088/geoserver/winsoft/wms";
      var imageUrl = urlOrigin + "/assets/img/";
      var tiledRaster = new ol.layer.Tile({ source: new ol.source.OSM(), name: "Podloga" });
      var overlay = new ol.Overlay({ position: "bottom-center", element: document.querySelector("#overlay") });

      var idObjekta;

      function popuniKontrole(odgovor) {
        var atributi = odgovor.features[0]["properties"];
        idObjekta = odgovor.features[0]["id"];
        document.querySelector("#latinskiNaziv").value = atributi["latinski_naziv"];
        document.querySelector("#narodniNaziv").value = atributi["narodni_naziv"];
        document.querySelector("#tip").value = atributi["tip"];
        document.querySelector("#tipKragne").value = atributi["tip_kragne"];
        document.querySelector("#visinaStabla").value = atributi["visina_stabla"];
        document.querySelector("#visinaDebla").value = atributi["visina_debla"];
        document.querySelector("#prsniPrecnik").value = atributi["prsni_precnik"];
        document.querySelector("#sirinaKrosnje").value = atributi["sirina_krosnje"];
        document.querySelector("#fitopatoloskePromjene").value = atributi["fitopatoloske_promjene"];
        document.querySelector("#vrstaFitopatoloskePromjene").value = atributi["vrsta_fitopatoloske_promjene"];
        document.querySelector("#entomoloskePromjene").value = atributi["entomoloske_promjene"];
        document.querySelector("#vrstaEntomoloskePromjene").value = atributi["vrsta_entomoloske_promjene"];
        document.querySelector("#izrazenostOtvoreneTruleziDebla").value = atributi["izrazenost_otvorene_trulezi_debla"];
        document.querySelector("#velicinaOtvoreneTruleziDebla").value = atributi["velicina_otvorene_trulezi_debla"];
        document.querySelector("#izrazenostOtvoreneTruleziGrana").value = atributi["izrazenost_otvorene_trulezi_grana"];
        document.querySelector("#velicinaOtvoreneTruleziGrana").value = atributi["velicina_otvorene_trulezi_grana"];
        document.querySelector("#ocjenaVitalnosti").value = atributi["ocjena_vitalnosti"];
        document.querySelector("#ocjenaDekorativnosti").value = atributi["ocjena_dekorativnosti"];
        document.querySelector("#starost").value = atributi["starost"];
        document.querySelector("#ocekivanoTrajanjeZivota").value = atributi["ocekivano_trajanje_zivota"];
        document.querySelector("#vrijemeSadnje").value = atributi["vrijeme_sadnje"];
        document.querySelector("#cijenaSadnice").value = atributi["cijena_sadnice"];
        document.querySelector("#napomena").value = atributi["napomena"];
        document.querySelector("#ostaliDetalji").value = atributi["ostali_detalji"];

        (atributi["slomljene_grane"] === true || atributi["slomljene_grane"] === "da") && (document.querySelector("#slomljeneGrane").checked = true);
        (atributi["suve_grane"] === true || atributi["suve_grane"] === "da") && (document.querySelector("#suveGrane").checked = true);
        (atributi["suhovrhost"] === true || atributi["suhovrhost"] === "da") && (document.querySelector("#suhovrhost").checked = true);
        (atributi["isjecene_debele_grane"] === true || atributi["isjecene_debele_grane"] === "da") && (document.querySelector("#isjeceneDebeleGrane").checked = true);
        (atributi["premazivanje_nakon_sjece"] === true || atributi["premazivanje_nakon_sjece"] === "da") && (document.querySelector("#premazivanjeNakonSjece").checked = true);
        (atributi["kvalitet"] === true || atributi["kvalitet"] === "da") && (document.querySelector("#kvalitet").checked = true);
        (atributi["isjeceno_uklonjeno_stablo"] === true || atributi["isjeceno_uklonjeno_stablo"] === "da") && (document.querySelector("#isjecenoUklonjenoStablo").checked = true);
        (atributi["pripadnost_drvoredu"] === true || atributi["pripadnost_drvoredu"] === "da") && (document.querySelector("#pripadnostDrvoredu").checked = true);

        //slika
        var slika = atributi["url_fotografije"];
        slika.length && (slika = slika.substring(slika.lastIndexOf("/") + 1, slika.length));
        overlay.getElement().innerHTML = '<a target="_blank" href="' + imageUrl + slika + '"><img src="' + imageUrl + slika + '"></a>';
      }

      //Da na ENTER ima istu funkcionalnost kao na save
      $(document).keypress(function(event) {
        if (event.which === 13) {
          sacuvaj();
        }
      });

      function sacuvaj() {
        alert(document.querySelector("#pripadnostDrvoredu").checked);
        if (!idObjekta) {
          alert("Potrebno je odabrati objekat za koji se unose podaci.");
          return false;
        }
        $.ajax({
          //url: '${createLink(controller:"plaza",action:"aktivnePlaze")}',
          url: "http://localhost:8080/gispodgorica/drvece/sacuvaj",
          //data: 'strana='+this.tekucaStrana+'&listovi='+JSON.stringify(this.listovi)+'&napopustu='+napopustu+'&nalageru='+nalageru+'&sort='+sort,
          data: {
            id: idObjekta,
            latinskiNaziv: document.querySelector("#latinskiNaziv").value,
            narodniNaziv: document.querySelector("#narodniNaziv").value,
            tip: document.querySelector("#tip").value,
            tipKragne: document.querySelector("#tipKragne").value,
            visinaStabla: document.querySelector("#visinaStabla").value,
            visinaDebla: document.querySelector("#visinaDebla").value,
            prsniPrecnik: document.querySelector("#prsniPrecnik").value,
            sirinaKrosnje: document.querySelector("#sirinaKrosnje").value,
            fitopatoloskePromjene: document.querySelector("#fitopatoloskePromjene").value,
            vrstaFitopatoloskePromjene: document.querySelector("#vrstaFitopatoloskePromjene").value,
            entomoloskePromjene: document.querySelector("#entomoloskePromjene").value,
            vrstaEntomoloskePromjene: document.querySelector("#vrstaEntomoloskePromjene").value,
            izrazenostOtvoreneTruleziDebla: document.querySelector("#izrazenostOtvoreneTruleziDebla").value,
            velicinaOtvoreneTruleziDebla: document.querySelector("#velicinaOtvoreneTruleziDebla").value,
            izrazenostOtvoreneTruleziGrana: document.querySelector("#izrazenostOtvoreneTruleziGrana").value,
            velicinaOtvoreneTruleziGrana: document.querySelector("#velicinaOtvoreneTruleziGrana").value,
            ocjenaVitalnosti: document.querySelector("#ocjenaVitalnosti").value,
            ocjenaDekorativnosti: document.querySelector("#ocjenaDekorativnosti").value,
            starost: document.querySelector("#starost").value,
            ocekivanoTrajanjeZivota: document.querySelector("#ocekivanoTrajanjeZivota").value,
            vrijemeSadnje: document.querySelector("#vrijemeSadnje").value,
            cijenaSadnice: document.querySelector("#cijenaSadnice").value,
            napomena: document.querySelector("#napomena").value,
            ostaliDetalji: document.querySelector("#ostaliDetalji").value,
            slomljeneGrane: document.querySelector("#slomljeneGrane").checked,
            suveGrane: document.querySelector("#suveGrane").checked,
            suhovrhost: document.querySelector("#suhovrhost").checked,
            isjeceneDebeleGrane: document.querySelector("#isjeceneDebeleGrane").checked,
            premazivanjeNakonSjece: document.querySelector("#premazivanjeNakonSjece").checked,
            kvalitet: document.querySelector("#kvalitet").checked,
            isjecenoUklonjenoStablo: document.querySelector("#isjecenoUklonjenoStablo").checked,
            pripadnostDrvoredu: document.querySelector("#pripadnostDrvoredu").checked
          },
          type: "POST",
          timeout: 10000,
          dataType: "json",
          async: false,
          error: function(success) {
            alert("Greška prilikom unosa podataka: \n" + xhr.responseText);
          },
          success: function(success) {
            alert("Uspjeh");
            restartovanje();
          }
        });

        /*rasterLayer.setSource(
          new ol.source.TileWMS({
            url: wmsUrl,
            params: {
              LAYERS: "winsoft:drvece",
              cql_filter: atributPretrage + " = " + vrijednostPretrage
            },
            crossOrigin: "anonymous"
          })
        );*/
      }

      function restartovanje() {
        idObjekta = "";
        document.querySelector("#latinskiNaziv").value = "";
        document.querySelector("#narodniNaziv").value = "";
        document.querySelector("#tip").value = "";
        document.querySelector("#tipKragne").value = "";
        document.querySelector("#visinaStabla").value = "";
        document.querySelector("#visinaDebla").value = "";
        document.querySelector("#prsniPrecnik").value = "";
        document.querySelector("#sirinaKrosnje").value = "";
        document.querySelector("#fitopatoloskePromjene").value = "";
        document.querySelector("#vrstaFitopatoloskePromjene").value = "";
        document.querySelector("#entomoloskePromjene").value = "";
        document.querySelector("#vrstaEntomoloskePromjene").value = "";
        document.querySelector("#izrazenostOtvoreneTruleziDebla").value = "";
        document.querySelector("#velicinaOtvoreneTruleziDebla").value = "";
        document.querySelector("#izrazenostOtvoreneTruleziGrana").value = "";
        document.querySelector("#velicinaOtvoreneTruleziGrana").value = "";
        document.querySelector("#ocjenaVitalnosti").value = "";
        document.querySelector("#ocjenaDekorativnosti").value = "";
        document.querySelector("#starost").value = "";
        document.querySelector("#ocekivanoTrajanjeZivota").value = "";
        document.querySelector("#vrijemeSadnje").value = "";
        document.querySelector("#cijenaSadnice").value = "";
        document.querySelector("#napomena").value = "";
        document.querySelector("#ostaliDetalji").value = "";
        document.querySelector("#slomljeneGrane").checked = false;
        document.querySelector("#suveGrane").checked = false;
        document.querySelector("#suhovrhost").checked = false;
        document.querySelector("#isjeceneDebeleGrane").checked = false;
        document.querySelector("#premazivanjeNakonSjece").checked = false;
        document.querySelector("#kvalitet").checked = false;
        document.querySelector("#isjecenoUklonjenoStablo").checked = false;
        document.querySelector("#pripadnostDrvoredu").checked = false;

        overlay.getElement().innerHTML = "";
      }

      var rasterLayer = new ol.layer.Tile({
        title: "Raster lejer",
        name: "Raster lejer",
        source: new ol.source.TileWMS({
          url: wmsUrl,
          params: {
            LAYERS: "winsoft:drvece"
          },
          crossOrigin: "anonymous"
        })
      });

      var center = ol.proj.transform([19.26, 42.443], "EPSG:4326", "EPSG:3857");
      var view = new ol.View({
        center: center,
        zoom: 17
      });

      var map = new ol.Map({
        target: "map",
        layers: [tiledRaster, rasterLayer], //
        view: view
      });

      map.on("pointermove", onMouseMove);

      function onMouseMove(browserEvent) {
        var coordinate = browserEvent.coordinate;
        var pixel = map.getPixelFromCoordinate(coordinate);
        var el = document.getElementById("name");
        el.innerHTML = "";
        map.forEachFeatureAtPixel(pixel, function(feature) {
          el.innerHTML += feature.get("broj") + "<br>";
        });
      }

      var dragAndDrop = new ol.interaction.DragAndDrop({
        formatConstructors: [ol.format.GPX, ol.format.GeoJSON, ol.format.IGC, ol.format.KML, ol.format.TopoJSON]
      });

      dragAndDrop.on("addfeatures", function(event) {
        var vectorSource = new ol.source.Vector({
          features: event.features,
          projection: event.projection
        });
        map.getLayers().push(
          new ol.layer.Vector({
            source: vectorSource,
            style: vectorStyle
          })
        );
        view.fitExtent(vectorSource.getExtent(), map.getSize());
      });
      map.addInteraction(dragAndDrop);

      //Klik na feature
      map.on("click", onMouseClick);

      function onMouseClick(browserEvent) {
        var coordinate = browserEvent.coordinate;
        var pixel = map.getPixelFromCoordinate(coordinate);

        var url = rasterLayer.getSource().getGetFeatureInfoUrl(browserEvent.coordinate, map.getView().getResolution(), "EPSG:3857", { INFO_FORMAT: "application/json" });
        if (url) {
          fetch(url)
            .then(function(response) {
              restartovanje();
              return response.text();
            })
            .then(function(json) {
              let odgovor = JSON.parse(json);
              if (odgovor.features.length > 0) {
                popuniKontrole(odgovor);
              }
            });
        }

        overlay.setPosition(coordinate);
        map.addOverlay(overlay);
      }
    </script>
  </body>
</html>
